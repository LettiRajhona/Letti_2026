<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 1. megold&aacute;sa:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   int</span> <span>parent</span> <span>=</span> <span>0</span><span>, </span><span>child</span> <span>=</span> <span>0</span><span>;<br /></span><span>   <br />   printf</span><span>(</span><span>"Enter the number of parents: "</span><span>);<br /></span><span>   scanf</span><span>(</span><span>"</span><span>%d</span><span>"</span><span>, </span><span>&amp;</span><span>parent</span><span>);</span><br /><br /><span>   printf</span><span>(</span><span>"Enter the number of children: "</span><span>);</span><br /><span>   scanf</span><span>(</span><span>"</span><span>%d</span><span>"</span><span>, </span><span>&amp;</span><span>child</span><span>);</span><br /><br /><span>   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>   if</span><span> (</span><span>pid</span> <span>&gt;</span> <span>0</span><span>) {</span><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>parent</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>         printf</span><span>(</span><span>"I am the parent! Process ID: </span><span>%d</span><span>\n</span><span>"</span><span>, </span><span>getpid</span><span>());</span><br /><span>         sleep</span><span>(</span><span>1</span><span>);</span><br /><span>      }</span><br /><br /><span>   } </span><span>else</span> <span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>child</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>         printf</span><span>(</span><span>"And? Process ID: </span><span>%d</span><span>\n</span><span>"</span><span>, </span><span>getpid</span><span>());</span><br /><span>         sleep</span><span>(</span><span>1</span><span>);</span><br /><span>      }</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 2. megold&aacute;sa:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;sys/types.h&gt;</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   int</span> <span>status</span><span>;</span><br /><span>   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>   if</span><span> (</span><span>pid</span> <span>&gt;</span> <span>0</span><span>) {</span><br /><span>      pid_t</span> <span>finished_child</span> <span>=</span> <span>wait</span><span>(</span><span>&amp;</span><span>status</span><span>);</span><br /><span>      printf</span><span>(</span><span>"Child with process ID </span><span>%d</span><span> finished running.</span><span>\n</span><span>"</span><span>, </span><span>finished_child</span><span>);</span><br /><br /><span>      if</span><span> (</span><span>WIFEXITED</span><span>(</span><span>status</span><span>)) {</span><br /><span>         printf</span><span>(</span><span>"Child exited with status </span><span>%d</span><span>.</span><span>\n</span><span>"</span><span>, </span><span>WEXITSTATUS</span><span>(</span><span>status</span><span>));</span><br /><span>      } </span><span>else</span><span> {</span><br /><span>         printf</span><span>(</span><span>"Child did not exit normally.</span><span>\n</span><span>"</span><span>);</span><br /><span>      }</span><br /><span>   } </span><span>else</span> <span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      printf</span><span>(</span><span>"Child with process ID </span><span>%d</span><span> is running.</span><span>\n</span><span>"</span><span>, </span><span>getpid</span><span>());</span><br /><span>     <br />      sleep</span><span>(</span><span>5</span><span>);</span><br /><span>      exit</span><span>(</span><span>7</span><span>);</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br />   return 0;<br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 3. megold&aacute;sa:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;sys/types.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;time.h&gt;</span><br /><br /><span>#define</span> <span>CHILD_COUNT</span> <span>3</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   int</span> <span>status</span><span>;</span><br /><span>   pid_t</span> <span>pid</span><span>;</span><br /><br /><span>   srand</span><span>(</span><span>time</span><span>(</span><span>NULL</span><span>));</span><br /><br /><span>   for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>CHILD_COUNT</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>      pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>      if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>         srand</span><span>(</span><span>getpid</span><span>());</span><br /><br /><span>         int</span> <span>sleepTime</span> <span>=</span> <span>rand</span><span>() </span><span>%</span> <span>10</span> <span>+</span> <span>1</span><span>;</span><br /><span>         int</span> <span>exitCode</span> <span>=</span> <span>rand</span><span>() </span><span>%</span> <span>256</span><span>; </span><br /><br /><span>         sleep</span><span>(</span><span>sleepTime</span><span>);</span><br /><span>         exit</span><span>(</span><span>exitCode</span><span>);</span><br /><span>      } </span><span>else</span><span> {</span><br /><span>         perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>         exit</span><span>(</span><span>1</span><span>);</span><br /><span>      }</span><br /><span>   }</span><br /><br /><span>   for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>CHILD_COUNT</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>      pid_t</span> <span>finished_child</span> <span>=</span> <span>wait</span><span>(</span><span>&amp;</span><span>status</span><span>);</span><br /><br /><span>      if</span><span> (</span><span>WIFEXITED</span><span>(</span><span>status</span><span>)) {</span><br /><span>         int</span> <span>exitCode</span> <span>=</span> <span>WEXITSTATUS</span><span>(</span><span>status</span><span>);</span><br /><span>         <br />         time_t</span> <span>now</span> <span>=</span> <span>time</span><span>(</span><span>NULL</span><span>);</span><br /><span>         struct</span> <span>tm</span> <span>*</span><span>localTime</span> <span>=</span> <span>localtime</span><span>(</span><span>&amp;</span><span>now</span><span>);</span><br /><span>         <br />         char</span> <span>timeStr</span><span>[</span><span>20</span><span>];</span><br /><span>         strftime</span><span>(</span><span>timeStr</span><span>, </span><span>sizeof</span><span>(</span><span>timeStr</span><span>), </span><span>"</span><span>%</span><span>Y-</span><span>%</span><span>m-</span><span>%d</span> <span>%</span><span>H:</span><span>%</span><span>M:</span><span>%S</span><span>"</span><span>, </span><span>localTime</span><span>);</span><br /><br /><span>         printf</span><span>(</span><span>"</span><span>%d</span><span> process successfully finished at </span><span>%s</span><span> with status code </span><span>%d</span><span>.</span><span>\n</span><span>"</span><span>,</span><br /><span>                finished_child</span><span>, </span><span>timeStr</span><span>, </span><span>exitCode</span><span>);</span><br /><br /><span>      }</span><br /><span>   }</span><br /><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4; font-size: 14pt;"><strong>&Oacute;rai feladat 4. megold&aacute;sa:</strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>   if</span><span> (</span><span>pid</span> <span>&gt;</span> <span>0</span><span>) {</span><br /><span>      wait</span><span>(</span><span>NULL</span><span>);</span><br /><span>      printf</span><span>(</span><span>"The children process program has finished.</span><span>\n</span><span>"</span><span>);</span><br /><span>   } </span><span>else</span> <span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      execlp</span><span>(</span><span>"ps"</span><span>, </span><span>"ps"</span><span>, </span><span>NULL</span><span>);</span><br /><br /><span>      perror</span><span>(</span><span>"execlp failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4; font-size: 14pt;"><strong>&Oacute;rai feladat 5. megold&aacute;sa z&aacute;rol&aacute;s n&eacute;lk&uuml;l:</strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;fcntl.h&gt;</span><br /><span>#include</span> <span>&lt;string.h&gt;<br /></span><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();<br /></span><br /><span>   const</span> <span>char</span><span>*</span> <span>child_msg</span> <span>=</span> <span>"Child process writing to file.</span><span>\n</span><span>"</span><span>;</span><br /><span>   const</span> <span>char</span><span>*</span> <span>parent_msg</span> <span>=</span> <span>"Parent process writing to file.</span><span>\n</span><span>"</span><span>;</span><br /><br /><span>   int</span> <span>file</span> <span>=</span> <span>open</span><span>(</span><span>"data.txt"</span><span>, </span><span>O_WRONLY</span> <span>|</span> <span>O_CREAT</span> <span>|</span> <span>O_APPEND</span><span>, </span><span>0644</span><span>);</span><br /><span><br />   if</span><span> (</span><span>pid</span> <span>&gt;</span> <span>0</span><span>) {</span><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>strlen</span><span>(</span><span>parent_msg</span><span>); </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>&amp;</span><span>parent_msg</span><span>[</span><span>i</span><span>], </span><span>1</span><span>);</span><br /><span>         usleep</span><span>(</span><span>100000</span><span>); </span><br /><span>      }</span><br /><br /><span>      wait</span><span>(</span><span>NULL</span><span>);</span><br /><span>   } </span><span>else</span> <span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>strlen</span><span>(</span><span>child_msg</span><span>); </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>&amp;</span><span>child_msg</span><span>[</span><span>i</span><span>], </span><span>1</span><span>);</span><br /><span>         usleep</span><span>(</span><span>150000</span><span>); </span><br /><span>      }</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br /><span>   close</span><span>(</span><span>file</span><span>);</span><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 5. megold&aacute;sa z&aacute;rol&aacute;ssal:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;fcntl.h&gt;</span><br /><span>#include</span> <span>&lt;string.h&gt;</span><br /><span>#include</span> <span>&lt;sys/file.h&gt;</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>   const</span> <span>char</span><span>*</span> <span>child_msg</span> <span>=</span> <span>"Child process writing to file.</span><span>\n</span><span>"</span><span>;</span><br /><span>   const</span> <span>char</span><span>*</span> <span>parent_msg</span> <span>=</span> <span>"Parent process writing to file.</span><span>\n</span><span>"</span><span>;</span><br /><br /><span>   int</span> <span>file</span> <span>=</span> <span>open</span><span>(</span><span>"data2.txt"</span><span>, </span><span>O_WRONLY</span> <span>|</span> <span>O_CREAT</span> <span>|</span> <span>O_APPEND</span><span>, </span><span>0644</span><span>);</span><br /><br /><span>   if</span><span> (</span><span>pid</span> <span>&gt;</span> <span>0</span><span>) {</span><br /><span>      flock</span><span>(</span><span>file</span><span>, </span><span>LOCK_EX</span><span>);</span><br /><span>      <br />      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>strlen</span><span>(</span><span>parent_msg</span><span>); </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>&amp;</span><span>parent_msg</span><span>[</span><span>i</span><span>], </span><span>1</span><span>);</span><br /><span>         usleep</span><span>(</span><span>100000</span><span>); </span><br /><br /><span>      }</span><br /><br /><span>      flock</span><span>(</span><span>file</span><span>, </span><span>LOCK_UN</span><span>); </span><br /><span>      wait</span><span>(</span><span>NULL</span><span>); </span><br /><span>   } </span><span>else</span> <span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      flock</span><span>(</span><span>file</span><span>, </span><span>LOCK_EX</span><span>);</span><br /><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>strlen</span><span>(</span><span>child_msg</span><span>); </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>&amp;</span><span>child_msg</span><span>[</span><span>i</span><span>], </span><span>1</span><span>);</span><br /><span>         usleep</span><span>(</span><span>150000</span><span>); </span><br /><span>      }</span><br /><br /><span>      flock</span><span>(</span><span>file</span><span>, </span><span>LOCK_UN</span><span>);</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      perror</span><span>(</span><span>"Fork failed"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br /><span>   close</span><span>(</span><span>file</span><span>);</span><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 6. megold&aacute;sa:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;fcntl.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;string.h&gt;</span><br /><br /><span>void</span> <span>lock_file</span><span>(</span><span>int</span> <span>file</span><span>) {</span><br /><span>   struct</span> <span>flock</span> <span>lock</span><span>;</span><br /><br /><span>   lock</span><span>.</span><span>l_type</span> <span>=</span> <span>F_WRLCK</span><span>; </span><br /><span>   lock</span><span>.</span><span>l_whence</span> <span>=</span> <span>SEEK_SET</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_start</span> <span>=</span> <span>0</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_len</span> <span>=</span> <span>0</span><span>; </span><br /><br /><span>   fcntl</span><span>(</span><span>file</span><span>, </span><span>F_SETLKW</span><span>, </span><span>&amp;</span><span>lock</span><span>); </span><br /><span>}</span><br /><br /><span>void</span> <span>unlock_file</span><span>(</span><span>int</span> <span>file</span><span>) {</span><br /><span>   struct</span> <span>flock</span> <span>lock</span><span>;</span><br /><br /><span>   lock</span><span>.</span><span>l_type</span> <span>=</span> <span>F_UNLCK</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_whence</span> <span>=</span> <span>SEEK_SET</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_start</span> <span>=</span> <span>0</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_len</span> <span>=</span> <span>0</span><span>;<br /></span><br /><span>   fcntl</span><span>(</span><span>file</span><span>, </span><span>F_SETLK</span><span>, </span><span>&amp;</span><span>lock</span><span>);</span><br /><span>}</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   int</span> <span>file</span> <span>=</span> <span>open</span><span>(</span><span>"output.txt"</span><span>, </span><span>O_WRONLY</span> <span>|</span> <span>O_CREAT</span> <span>|</span> <span>O_TRUNC</span> <span>|</span> <span>O_APPEND</span><span>, </span><span>0644</span><span>);</span><br /><br /><span>   if</span><span> (</span><span>file</span> <span>&lt;</span> <span>0</span><span>) {</span><br /><span>      perror</span><span>(</span><span>"Failed to open file"</span><span>);</span><br /><span>      exit</span><span>(</span><span>1</span><span>);</span><br /><span>   }</span><br /><br /><span>   for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>4</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>      pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><br /><span>      if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>         lock_file</span><span>(</span><span>file</span><span>);</span><br /><br /><span>         for</span><span> (</span><span>int</span> <span>j</span> <span>=</span> <span>0</span><span>; </span><span>j</span> <span>&lt;</span> <span>5</span><span>; </span><span>j</span><span>++</span><span>) {</span><br /><span>            char</span> <span>buffer</span><span>[</span><span>100</span><span>];</span><br /><span>            snprintf</span><span>(</span><span>buffer</span><span>, </span><span>sizeof</span><span>(</span><span>buffer</span><span>), </span><span>"Process </span><span>%d</span><span> writes in line </span><span>%d</span><span>\n</span><span>"</span><span>, </span><span>i</span><span>, </span><span>j</span> <span>+</span> <span>1</span><span>);</span><br /><br /><span>            write</span><span>(</span><span>file</span><span>, </span><span>buffer</span><span>, </span><span>strlen</span><span>(</span><span>buffer</span><span>));</span><br /><span>            usleep</span><span>(</span><span>100000</span><span>);</span><br /><br /><span>         }</span><br /><br /><span>         unlock_file</span><span>(</span><span>file</span><span>);</span><br /><span>         close</span><span>(</span><span>file</span><span>);</span><br /><br /><span>         exit</span><span>(</span><span>0</span><span>);</span><br /><span>      }</span><br /><span>   }</span><br /><br /><span>   for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>4</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>      wait</span><span>(</span><span>NULL</span><span>);</span><br /><span>   }</span><br /><br /><span>   close</span><span>(</span><span>file</span><span>);</span><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; background-color: #c2e0f4;"><strong><span style="font-size: 14pt; background-color: #c2e0f4;">&Oacute;rai feladat 7. megold&aacute;sa:</span></strong></span></p>
<div>
<pre><span>#include</span> <span>&lt;stdio.h&gt;</span><br /><span>#include</span> <span>&lt;stdlib.h&gt;</span><br /><span>#include</span> <span>&lt;unistd.h&gt;</span><br /><span>#include</span> <span>&lt;fcntl.h&gt;</span><br /><span>#include</span> <span>&lt;sys/wait.h&gt;</span><br /><span>#include</span> <span>&lt;string.h&gt;</span><br /><br /><span>void</span> <span>lock_first_half</span><span>(</span><span>int</span> <span>file</span><span>, </span><span>off_t</span> <span>filesize</span><span>) {</span><br /><span>   struct</span> <span>flock</span> <span>lock</span><span>;</span><br /><br /><span>   lock</span><span>.</span><span>l_type</span> <span>=</span> <span>F_WRLCK</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_whence</span> <span>=</span> <span>SEEK_SET</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_start</span> <span>=</span> <span>0</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_len</span> <span>=</span> <span>filesize</span> <span>/</span> <span>2</span><span>;</span><br /><br /><span>   printf</span><span>(</span><span>"Child locking first half...</span><span>\n</span><span>"</span><span>);</span><br /><span>   fcntl</span><span>(</span><span>file</span><span>, </span><span>F_SETLKW</span><span>, </span><span>&amp;</span><span>lock</span><span>);</span><br /><span>}</span><br /><br /><span>void</span> <span>unlock_file</span><span>(</span><span>int</span> <span>file</span><span>, </span><span>off_t</span> <span>filesize</span><span>) {</span><br /><span>   struct</span> <span>flock</span> <span>lock</span><span>;</span><br /><br /><span>   lock</span><span>.</span><span>l_type</span> <span>=</span> <span>F_UNLCK</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_whence</span> <span>=</span> <span>SEEK_SET</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_start</span> <span>=</span> <span>0</span><span>;</span><br /><span>   lock</span><span>.</span><span>l_len</span> <span>=</span> <span>filesize</span> <span>/</span> <span>2</span><span>;</span><br /><br /><span>   fcntl</span><span>(</span><span>file</span><span>, </span><span>F_SETLK</span><span>, </span><span>&amp;</span><span>lock</span><span>);</span><br /><span>}</span><br /><br /><span>int</span> <span>main</span><span>() {</span><br /><span>   const</span> <span>char</span><span>*</span> <span>child_msg</span> <span>=</span> <span>"Child process is writing...</span><span>\n</span><span>"</span><span>;</span><br /><span>   const</span> <span>char</span><span>*</span> <span>parent_msg</span> <span>=</span> <span>"Parent process is writing...</span><span>\n</span><span>"</span><span>;</span><br /><br /><span>   int</span> <span>file</span> <span>=</span> <span>open</span><span>(</span><span>"data.txt"</span><span>, </span><span>O_WRONLY</span> <span>|</span> <span>O_CREAT</span> <span>|</span> <span>O_TRUNC</span> <span>|</span> <span>O_APPEND</span><span>, </span><span>0644</span><span>);</span><br /><span>   if</span><span> (</span><span>file</span> <span>&lt;</span> <span>0</span><span>) { </span><br /><span>      perror</span><span>(</span><span>"open"</span><span>); </span><br /><span>      exit</span><span>(</span><span>1</span><span>); </span><br /><span>   }</span><br /><br /><span>   for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>20</span><span>; </span><span>i</span><span>++</span><span>)</span><br /><span>      write</span><span>(</span><span>file</span><span>, </span><span>"0123456789</span><span>\n</span><span>"</span><span>, </span><span>11</span><span>);<br /></span><br /><span>   close</span><span>(</span><span>file</span><span>);</span><br /><br /><span>   file</span> <span>=</span> <span>open</span><span>(</span><span>"data.txt"</span><span>, </span><span>O_WRONLY</span> <span>|</span> <span>O_APPEND</span><span>, </span><span>0644</span><span>);</span><br /><span>   if</span><span> (</span><span>file</span> <span>&lt;</span> <span>0</span><span>) { </span><br /><span>      perror</span><span>(</span><span>"open"</span><span>); </span><br /><span>      exit</span><span>(</span><span>1</span><span>); </span><br />   <span>}</span><br /><br /><span>   off_t</span> <span>filesize</span> <span>=</span> <span>lseek</span><span>(</span><span>file</span><span>, </span><span>0</span><span>, </span><span>SEEK_END</span><span>);</span><br /><span>   <br />   pid_t</span> <span>pid</span> <span>=</span> <span>fork</span><span>();</span><br /><span>   if</span><span> (</span><span>pid</span> <span>&lt;</span> <span>0</span><span>) { </span><br /><span>      perror</span><span>(</span><span>"fork"</span><span>); </span><br /><span>      exit</span><span>(</span><span>1</span><span>); </span><br /><span>   } else </span><span>if</span><span> (</span><span>pid</span> <span>==</span> <span>0</span><span>) {</span><br /><span>      lock_first_half</span><span>(</span><span>file</span><span>, </span><span>filesize</span><span>);</span><br /><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>10</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>child_msg</span><span>, </span><span>strlen</span><span>(</span><span>child_msg</span><span>));</span><br /><span>         sleep</span><span>(</span><span>1</span><span>);</span><br /><span>      }</span><br /><br /><span>      unlock_file</span><span>(</span><span>file</span><span>, </span><span>filesize</span><span>);</span><br /><span>      close</span><span>(</span><span>file</span><span>);</span><br /><br /><span>      exit</span><span>(</span><span>0</span><span>);</span><br /><span>   } </span><span>else</span><span> {</span><br /><span>      for</span><span> (</span><span>int</span> <span>i</span> <span>=</span> <span>0</span><span>; </span><span>i</span> <span>&lt;</span> <span>10</span><span>; </span><span>i</span><span>++</span><span>) {</span><br /><span>         write</span><span>(</span><span>file</span><span>, </span><span>parent_msg</span><span>, </span><span>strlen</span><span>(</span><span>parent_msg</span><span>));</span><br /><span>         sleep</span><span>(</span><span>1</span><span>);</span><br /><span>      }</span><br /><br /><span>      wait</span><span>(</span><span>NULL</span><span>);</span><br /><span>      close</span><span>(</span><span>file</span><span>);</span><br /><span>   }</span><br /><br /><span>   return</span> <span>0</span><span>;</span><br /><span>}</span></pre>
</div>